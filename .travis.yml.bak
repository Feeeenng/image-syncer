dist: bionic

sudo: required

language: shell

services: 
  - docker

env:
 global:
   - DOCKERHUB_USERNAME=willdockerhub 

before_install:
  - openssl aes-256-cbc -K $encrypted_2276f9b26903_key -iv $encrypted_2276f9b26903_iv -in gcloud-sdk.json.enc -out gcloud-sdk.json -d
  - echo "$DOCKERHUB_PASSWORD" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
   
install: 
>-
  docker run -it --rm -v ${PWD}:/workspace -w /workspace google/cloud-sdk:alpine
  bash -c
  "gcloud auth activate-service-account --key-file gcloud-sdk.json \
   && gcloud container images list-tags k8s.gcr.io/metrics-server/metrics-server --format='table(TAGS)' --filter='tags:*' | grep -v TAGS > metrics-server-tags.list"

script:
  - |
    for TAG in `cat metrics-server-tags.list`
    do
      docker pull k8s.gcr.io/metrics-server/metrics-server:$TAG
      docker tag k8s.gcr.io/metrics-server/metrics-server:$TAG $DOCKERHUB_USERNAME/metrics-server:$TAG
      docker push $DOCKERHUB_USERNAME/metrics-server:$TAG
    done

after_script:
  - docker images --format "{{.Repository}}:{{.Tag}}" | grep $DOCKERHUB_USERNAME  
